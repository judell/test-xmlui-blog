<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XMLUI blog test</title>
  <script src="xmlui/xmlui-standalone.umd.js"></script>
  <script src="xmlui/xmlui-playground.js"></script>
<script>

  window.blogIsIndexing = '';

  window.setBlogIndexing = function() {
    window.blogIsIndexing = 'indexing'
  }

  window.stopBlogIndexing = function() {
    window.blogIsIndexing = 'done'
  }

  // Initialize blog search data
  window.blogPosts = {};

  // Getter function
  window.getblogPosts = function() {
    return window.blogPosts;
  };

    // Setter function
  window.setBlogSearchEntry = function(key, content) {
    console.log('Raw content length:', content.length);
    console.log('Raw content preview:', content.substring(0, 200));
    console.log('Raw content end:', content.substring(content.length - 200));

    window.blogPosts[key] = content;
  };

  // Get count function
  window.getBlogSearchCount = function() {
    return Object.keys(window.blogPosts).length;
  };

    // Search function that returns filtered results
  window.searchBlogPosts = function(posts, searchIndex, query) {
    console.log('Search query:', query);
    console.log('Search index keys:', Object.keys(searchIndex));

    if (!query || !posts || !searchIndex) return [];

    const results = [];
    Object.keys(posts).forEach(function(key) {
      const post = posts[key];
      const queryLower = query.toLowerCase();

      // Search in title
      if (post.title.toLowerCase().includes(queryLower)) {
        results.push({
          key: key,
          post: post,
          matchType: 'title',
          context: post.title
        });
        return;
      }

      // Search in content - find all occurrences
      const content = searchIndex['/blog/' + post.slug];
      if (content && content.toLowerCase().includes(queryLower)) {
        let searchPos = 0;
        while (true) {
          const index = content.toLowerCase().indexOf(queryLower, searchPos);
          if (index === -1) break; // No more matches

          const start = Math.max(0, index - 100);
          const end = Math.min(content.length, index + 100);
          let context = content.substring(start, end);

          if (start > 0) context = '...' + context;
          if (end < content.length) context = context + '...';

          results.push({
            key: key,
            post: post,
            matchType: 'content',
            context: context
          });

          searchPos = index + 1; // Move past this match to find next one
        }
      }
    });

    return results;
  };
</script>
</head>
<body>
</body>
</html>